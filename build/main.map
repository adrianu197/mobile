{"version":3,"sources":["webpack:///webpack/bootstrap 8d3cd2c8328d61da25ff","webpack:///./src/index.js","webpack:///./node_modules/babel-runtime/regenerator/index.js","webpack:///external \"regenerator-runtime\"","webpack:///external \"koa\"","webpack:///external \"http\"","webpack:///external \"ws\"","webpack:///external \"fs\"","webpack:///external \"koa-router\"","webpack:///external \"koa-cors\"","webpack:///external \"koa-jwt\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"koa-bodyparser\""],"names":["Koa","require","app","server","createServer","callback","WebSocket","wss","Server","fs","Router","cors","koaJwt","jwt","bodyparser","koaJwtKey","use","ctx","next","start","Date","ms","console","log","method","url","response","status","body","issue","error","message","secret","unless","path","Entry","id","date","pathToEntriesFile","pathToUsersFile","saveToFile","jsonObject","writeFile","JSON","stringify","err","usersContent","readFileSync","contents","entries","parse","users","lastUpdated","length","lastId","pageSize","broadcast","clients","forEach","client","readyState","OPEN","send","data","router","post","user","request","found","find","obj","email","password","outcome","token","sign","role","userId","get","query","page","parseInt","warning","set","toUTCString","sortedEntries","filter","note","sort","n1","n2","offset","slice","more","entryId","params","entry","createEntry","push","event","put","index","findIndex","del","splice","routes","allowedMethods","listen"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 8d3cd2c8328d61da25ff","const Koa = require('koa');\r\nconst app = new Koa();\r\nconst server = require('http').createServer(app.callback());\r\nconst WebSocket = require('ws');\r\nconst wss = new WebSocket.Server({server});\r\nconst fs = require('fs');\r\nconst Router = require('koa-router');\r\nconst cors = require('koa-cors');\r\nconst koaJwt = require('koa-jwt');\r\nconst jwt = require('jsonwebtoken');\r\nconst bodyparser = require('koa-bodyparser');\r\n\r\n\r\nconst koaJwtKey = 'mySecretKey';\r\n\r\napp.use(bodyparser()); //1\r\napp.use(cors()); //2\r\napp.use(async (ctx, next) => { // logger\r\n  const start = new Date();\r\n  await next();\r\n  const ms = new Date() - start;\r\n  console.log(`${ctx.method} ${ctx.url} ${ctx.response.status} - ${ms}ms`);\r\n});\r\n\r\napp.use(async (ctx, next) => { // error handler\r\n  try {\r\n    await next();\r\n  } catch (err) {\r\n    ctx.response.body = {issue: [{error: err.message || 'Unexpected error'}]};\r\n    ctx.response.status = 500; // internal server error\r\n  }\r\n});\r\n\r\napp.use(koaJwt({secret: koaJwtKey}).unless({path: [/^\\/auth/]}));\r\n\r\nclass Entry {\r\n  constructor({id, body, date}) {\r\n    this.id = id;\r\n    this.body = body;\r\n    this.date = date;\r\n  }\r\n}\r\n\r\nconst pathToEntriesFile = 'data/entries.json';\r\nconst pathToUsersFile = 'data/users.json';\r\n\r\nconst saveToFile = (jsonObject) => {\r\n  fs.writeFile(pathToEntriesFile, JSON.stringify(jsonObject), function (err) {\r\n    if (err) {\r\n      return console.log(err);\r\n    }\r\n  });\r\n}\r\n\r\nconst usersContent = fs.readFileSync(pathToUsersFile, 'utf8', function (err) {\r\n  if (err) {\r\n    return console.log(err);\r\n  }\r\n});\r\n\r\nconst contents = fs.readFileSync(pathToEntriesFile, 'utf8', function (err) {\r\n  if (err) {\r\n    return console.log(err);\r\n  }\r\n});\r\n\r\nconst entries = (JSON.parse(contents));\r\nconst users = JSON.parse(usersContent);\r\nlet lastUpdated = entries[entries.length - 1].date;\r\nlet lastId = entries[entries.length - 1].id;\r\n\r\nconst pageSize = 10;\r\n\r\nconst broadcast = data => {\r\n  wss.clients.forEach(client => {\r\n    if (client.readyState === WebSocket.OPEN) {\r\n      client.send(JSON.stringify(data));\r\n    }\r\n  });\r\n}\r\n\r\nconst router = new Router();\r\n\r\nrouter.post('/auth', async (ctx) => {\r\n  const user = ctx.request.body;\r\n  console.log(user);\r\n  const found = users.find(obj => obj.email === user.email && obj.password === user.password);\r\n  if (found != -1) {\r\n    ctx.response.body = {outcome: 'Succes'};\r\n    ctx.response.status = 200;\r\n    ctx.body = {\r\n      token: jwt.sign({role: 'admin'}, koaJwtKey), //Should be the same secret key as the one used is ./koaJwt.js\r\n      message: \"Successfully logged in!\",\r\n      userId: found.id\r\n    };\r\n  } else {\r\n    ctx.response.body = {outcome: 'Invalid credentials.'};\r\n    ctx.response.status = 401;\r\n  }\r\n});\r\n\r\n\r\n\r\nrouter.get('/entry', ctx => {\r\n  const body = ctx.request.query.body;\r\n  const page = parseInt(ctx.request.query.page) || 1;\r\n  const user = parseInt(ctx.request.query.user);\r\n  if (!user) {\r\n    ctx.response.body = {issue: [{warning: `No user specified.`}]};\r\n    ctx.response.status = 400; // NOT FOUND (if you know the resource was deleted, then return 410 GONE)\r\n    return;\r\n  }\r\n  ctx.response.set('Last-Modified', new Date(lastUpdated).toUTCString());\r\n  const sortedEntries = entries\r\n    .filter(note => note.userId == user)\r\n    .sort((n1, n2) => -(n1.date - n2.date));\r\n  const offset = (page - 1) * pageSize;\r\n  ctx.response.body = {\r\n    page,\r\n    entries: sortedEntries.slice(offset, offset + pageSize),\r\n    more: offset + pageSize < sortedEntries.length\r\n  };\r\n  ctx.response.status = 200; // OK\r\n});\r\n\r\nrouter.get('/entry/:id', async (ctx) => {\r\n  const entryId = ctx.request.params.id;\r\n  const entry = entries.find(entry => entryId === entry.id);\r\n  if (entry) {\r\n    ctx.response.body = entry;\r\n    ctx.response.status = 200; // ok\r\n  } else {\r\n    ctx.response.body = {issue: [{warning: `Entry with id ${entryId} not found`}]};\r\n    ctx.response.status = 404; // NOT FOUND (if you know the resource was deleted, then return 410 GONE)\r\n  }\r\n});\r\n\r\nconst createEntry = async (ctx) => {\r\n  const entry = ctx.request.body;\r\n  console.log(entry);\r\n  if (!entry.body) { // validation\r\n    ctx.response.body = {issue: [{error: 'Entry body is missing'}]};\r\n    ctx.response.status = 400; //  BAD REQUEST\r\n    return;\r\n  }\r\n  if (entry.status == 'ADDED') entry.status = 'SYNCED';\r\n\r\n  entry.id = `${parseInt(lastId) + 1}`;\r\n  lastId = entry.id;\r\n  entries.push(entry);\r\n  ctx.response.body = entry;\r\n  ctx.response.status = 201; // CREATED\r\n  broadcast({event: 'created', entry});\r\n};\r\n\r\n\r\n\r\nrouter.post('/entry', async (ctx) => {\r\n  await createEntry(ctx);\r\n  saveToFile(entries);\r\n});\r\n\r\n\r\n\r\nrouter.put('/entry/:id', async (ctx) => {\r\n  const id = ctx.params.id;\r\n  const entry = ctx.request.body;\r\n  const entryId = entry.id;\r\n  if (entryId && id !== entry.id) {\r\n    ctx.response.body = {issue: [{error: `Param id and body id should be the same`}]};\r\n    ctx.response.status = 400; // BAD REQUEST\r\n    return;\r\n  }\r\n  // if (!noteId) {\r\n  //   await createEntry(ctx);\r\n  //   return;\r\n  // }\r\n  const index = entries.findIndex(obj => obj.id == id);\r\n  if (index === -1) {\r\n    ctx.response.body = {issue: [{error: `Entry with id ${id} not found`}]};\r\n    ctx.response.status = 400; // BAD REQUEST\r\n    return;\r\n  }\r\n  // if (noteVersion < entries[index].version) {\r\n  //   ctx.response.body = {issue: [{error: `Version conflict`}]};\r\n  //   ctx.response.status = 409; // CONFLICT\r\n  //   return;\r\n  // }\r\n  entries[index] = entry;\r\n  ctx.response.body = entry;\r\n  ctx.response.status = 200; // OK\r\n  broadcast({event: 'updated', entry});\r\n  saveToFile(entries);\r\n});\r\n\r\nrouter.del('/entry/:id', ctx => {\r\n  const id = ctx.params.id;\r\n  const index = entries.findIndex(entry => id == entry.id);\r\n  if (index !== -1) {\r\n    const entry = entries[index];\r\n    entries.splice(index, 1);\r\n    saveToFile(entries);\r\n    lastUpdated = new Date();\r\n    broadcast({event: 'deleted', entry});\r\n  }\r\n  ctx.response.status = 204; // no content\r\n});\r\n\r\n// setInterval(() => {\r\n//   lastUpdated = new Date();\r\n//   lastId = `${parseInt(lastId) + 1}`;\r\n//   const note = new Note({ id: lastId, text: `Note ${lastId}`, date: lastUpdated, version: 1 });\r\n//   entries.push(note);\r\n//   console.log(`\r\n//    ${note.text}`);\r\n//   broadcast({ event: 'created', note });\r\n// }, 15000);\r\n\r\napp.use(router.routes());\r\napp.use(router.allowedMethods());\r\n\r\nserver.listen(3000);\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"regenerator-runtime\");\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/babel-runtime/regenerator/index.js\n// module id = 2\n// module chunks = 0","module.exports = require(\"regenerator-runtime\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"regenerator-runtime\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"koa\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"http\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"http\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"ws\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"ws\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"koa-router\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-router\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"koa-cors\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-cors\"\n// module id = 9\n// module chunks = 0","module.exports = require(\"koa-jwt\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-jwt\"\n// module id = 10\n// module chunks = 0","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"koa-bodyparser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"koa-bodyparser\"\n// module id = 12\n// module chunks = 0"],"sourceRoot":""}